<!DOCTYPE html>
<html lang="en">
<head>
    <title>SafeSwap - Home</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='globals.css') }}">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins&display=swap');

        body {
            background-color: #ffffff;
            margin: 0;
            font-family: 'Poppins', sans-serif;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            scroll-behavior: smooth;
        }

        nav {
            background-color: #0b3d0b;
            padding: 1rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        nav a {
            background-color: #2e7d32;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            text-decoration: none;
            font-weight: bold;
            transition: transform 0.3s ease, background-color 0.3s ease;
            display: inline-block;
        }

        nav a:hover {
            background-color: #388e3c;
            transform: scale(1.05);
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 2rem 1rem;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            margin: 1rem;
            opacity: 0;
            animation: fadeIn 1s ease forwards;
            animation-delay: 0.3s;
        }

        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .title-container img {
            height: 60px;
            margin-right: 1rem;
            border-radius: 12px;
        }

        .title-container h1 {
            font-size: 2.5rem;
            margin: 0;
            color: #1f2937;
        }

        .quote-container {
            opacity: 0;
            animation: fadeIn 2s ease forwards;
            margin-bottom: 2rem;
            animation-delay: 0.5s;
        }

        .quote-text {
            font-family: 'Times New Roman', Times, serif;
            font-size: 2rem;
            font-style: italic;
            color: #374151;
        }

        .quote-source {
            display: block;
            margin-top: 0.5rem;
            font-size: 1.2rem;
            color: #555;
        }

        .bridge-text {
            opacity: 0;
            animation: fadeInBridge 2s ease forwards;
            animation-delay: 1s;
            max-width: 800px;
            font-size: 1.1rem;
            line-height: 1.6rem;
            margin-bottom: 2rem;
            color: #374151;
        }

        p {
            font-size: 1rem;
            margin-bottom: 1.5rem;
            color: #555;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .btn {
            background-color: #4caf50;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }

        video {
            display: none;
            margin-top: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #loadingSpinner {
            display: none;
            margin-top: 1rem;
            font-size: 1.2rem;
            color: #2e7d32;
            animation: blink 1s infinite;
        }

        #checkmark {
            display: none;
            font-size: 2rem;
            color: #4caf50;
            margin-top: 1rem;
        }

        #confidenceBarContainer {
            width: 250px;
            height: 16px;
            background: #eee;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
            display: none;
        }

        #confidenceBar {
            height: 100%;
            width: 0%;
            background: #4caf50;
            transition: width 0.3s ease, background-color 0.3s ease;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes fadeInBridge {
            to { opacity: 1; }
        }

        @keyframes blink {
            0%,100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <main>
        <div class="title-container">
            <img src="{{ url_for('static', filename='safeswap.png') }}" alt="SafeSwap Logo">
            <h1>SafeSwap</h1>
        </div>
        <div class="quote-container">
            <p class="quote-text">"The Human Brain May Contain as Much as a Spoon‚Äôs Worth of Microplastics"
                <span class="quote-source">‚Äì Smithsonian Magazine</span></p>
        </div>
        <div class="bridge-text">
            <p>Microplastics are tiny plastic fragments less than 5 micrometers in diameter, with emerging research warning of their largely unknown effects on human health.</p>
            <p>SafeSwap uses computer vision and object detection to help you identify everyday items that may contribute to microplastic exposure over time.</p>
        </div>
        <p>Choose to upload an image or use your camera to scan an item:</p>
        <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm" class="button-group">
            <input type="file" name="file" accept="image/*" id="fileInput" style="display:none;">
            <label for="fileInput" class="btn">Upload Image</label>
            <button type="button" id="startWebcamBtn" class="btn">Start Scanning</button>
        </form>
        <video id="video" width="320" height="240" autoplay muted></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="loadingSpinner">üîç Scanning...</div>
        <div id="checkmark">‚úÖ</div>
        <div id="confidenceBarContainer"><div id="confidenceBar"></div></div>
    </main>
    <script>
        const startWebcamBtn = document.getElementById('startWebcamBtn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const fileInput = document.getElementById('fileInput');
        const uploadForm = document.getElementById('uploadForm');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const checkmark = document.getElementById('checkmark');
        const confidenceBarContainer = document.getElementById('confidenceBarContainer');
        const confidenceBar = document.getElementById('confidenceBar');

        startWebcamBtn.addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            loadingSpinner.style.display = 'block';
            confidenceBarContainer.style.display = 'block';
            startDetectionLoop();
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                loadingSpinner.style.display = 'block';
                uploadForm.submit();
            }
        });

        function startDetectionLoop() {
            setInterval(async () => {
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const dataURL = canvas.toDataURL('image/jpeg');
                const res = await fetch('/detect_frame', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: dataURL })
                });
                const result = await res.json();

                if (result.success) {
                    loadingSpinner.style.display = 'none';
                    checkmark.style.display = 'block';
                    confidenceBar.style.width = '100%';
                    confidenceBar.style.backgroundColor = '#4caf50';
                    setTimeout(() => window.location.href = result.redirect_url, 1500);
                } else if (result.confidence !== undefined) {
                    const pct = Math.min(Math.floor((result.confidence / 0.75) * 100), 100);
                    confidenceBar.style.width = pct + '%';
                    confidenceBar.style.backgroundColor = pct < 50 ? 'red' : pct < 80 ? 'orange' : '#4caf50';
                }
            }, 1500);
        }
    </script>
</body>
</html>